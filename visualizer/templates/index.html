<!DOCTYPE html>
<html>

<head>
    <title>Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <style>
        #mapid {
            height: 500px;
        }

        .connection-sign {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .connection-sign.connected {
            background-color: green;
        }

        .connection-sign.disconnected {
            background-color: red;
        }

        .connection-sign.gray {
            background-color: gray;
        }

        #connection-table {
            width: auto;
            margin-top: 10px;
            border-collapse: collapse;
        }

        #connection-table th,
        #connection-table td {
            padding: 5px;
            text-align: center;
            border: 1px solid black;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
</head>

<body>
    <div id="mapid"></div>
    <div id="connection-table-placeholder"></div> <!-- Placeholder div for the table -->
    <div id="pulled-over-placeholder"></div> <!-- Placeholder div for the table -->
    <button id="start-button" onclick="startSimulation()">Start Simulation</button>
    <button id="stop-button" onclick="stopSimulation()">Stop Simulation</button>
    <button id="situation1-button" onclick="situation1()">Situation 1</button>
    <script>
        // initialize the map on the "map" div with a given center and zoom
        var mymap = L.map('mapid').setView([40.63260789120826, -8.655074423121608], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(mymap);
        var carIcon = L.icon({
            iconUrl: 'static/car.png',

            iconSize: [30, 30], // size of the icon
        });
        var ambulanceIcon = L.icon({
            iconUrl: 'static/ambulance.png',

            iconSize: [30, 30], // size of the icon
        });
        var antennaIcon = L.icon({
            iconUrl: 'static/antena.png',

            iconSize: [30, 30], // size of the icon
        });

        var rsu_1 = L.marker([40.6334546665471, -8.654870575236478], { icon: antennaIcon }).addTo(mymap);
        var rsu_2 = L.marker([40.632412479977084, -8.65541774587554], { icon: antennaIcon }).addTo(mymap);
        var rsu_3 = L.marker([40.63198986375213, -8.653578792259104], { icon: antennaIcon }).addTo(mymap);
        var rsu_4 = L.marker([40.632942494084666, -8.653278384842281], { icon: antennaIcon }).addTo(mymap);

        var car_1 = L.marker([0, 0], { icon: ambulanceIcon }).addTo(mymap);
        var car_2 = L.marker([0, 0], { icon: carIcon }).addTo(mymap);
        car_2.bindPopup("<b>Car 2</b><br>Station Id: 6</br>");
        var car_3 = L.marker([0, 0], { icon: carIcon }).addTo(mymap);
        car_3.bindPopup("<b>Car 3</b><br>Station Id: 7</br>");
        var car_4 = L.marker([0, 0], { icon: carIcon }).addTo(mymap);
        car_4.bindPopup("<b>Car 4</b><br>Station Id: 8</br>");
        var car_5 = L.marker([0, 0], { icon: carIcon }).addTo(mymap);
        car_5.bindPopup("<b>Car 5</b><br>Station Id: 9</br>");
        var car_6 = L.marker([0, 0], { icon: carIcon }).addTo(mymap);
        car_6.bindPopup("<b>Car 6</b><br>Station Id: 10</br>");

        var simulationRunning = false;
        var updateInterval;

        function startSimulation() {
            if (!simulationRunning) {
                simulationRunning = true;
                $.post('/start_simulation')
                updateInterval = setInterval(getStatus, "{{refresh_rate}}");
            }
        }
        
        function stopSimulation() {
            if (simulationRunning) {
                simulationRunning = false;
                clearInterval(updateInterval);
                $.post('/kill_simulation')
            }
        }

        function situation1() {
            if (!simulationRunning) {
                simulationRunning = true;
                $.post('/start_simulation', { situation_id: 1 })
                updateInterval = setInterval(getStatus, "{{refresh_rate}}");
            }
        }


        function getStatus() {
            $.getJSON('/state', function (json) {
                simulationRunning = !json[3];
                var connections = json[1];
                var ids = Object.keys(connections); // Get all the IDs from the JSON data

                // Generate the table structure dynamically if the JSON data is not empty
                var tableHtml = '';
                if (ids.length > 0) {
                    tableHtml += '<table id="connection-table">';
                    tableHtml += '<thead><tr><th></th>'; // Empty cell for the top-left corner
                    for (var i = 0; i < ids.length; i++) {
                        tableHtml += '<th>' + ids[i] + '</th>'; // Column headers based on IDs
                    }
                    tableHtml += '</tr></thead><tbody>';
                    for (var i = 0; i < ids.length; i++) {
                        var rowId = ids[i];
                        tableHtml += '<tr><th>' + rowId + '</th>'; // Row header based on ID
                        for (var j = 0; j < ids.length; j++) {
                            var columnId = ids[j];
                            var isConnected = connections[rowId][columnId];
                            var connectionClass = isConnected ? 'connected' : 'disconnected';
                            if (rowId === columnId) {
                                connectionClass += ' gray'; // Add gray class for the intersection where the column ID is the same as the row ID
                            }
                            tableHtml += '<td><span class="connection-sign ' + connectionClass + '"></span></td>'; // Table cell with connection sign
                        }
                        tableHtml += '</tr>';
                    }
                    tableHtml += '</tbody></table>';
                } else {
                    tableHtml += 'No data available.'; // Display a message if the JSON data is empty
                }

                // Replace the existing table or message with the updated table structure
                $('#connection-table-placeholder').html(tableHtml);

                var pulled_over = json[2]; // {id1: false, id2: true, ...}
                var ids = Object.keys(pulled_over); // Get all the IDs from the JSON data
                
                // Generate table with two columns [id, pulled_over]
                var tableHtml = '';
                if (ids.length > 0) {
                    tableHtml += '<table id="pulled-over-table">';
                    tableHtml += '<thead><tr><th>ID</th><th>Pulled Over</th></tr></thead><tbody>';
                    for (var i = 0; i < ids.length; i++) {
                        var rowId = ids[i];
                        tableHtml += '<tr><th>' + rowId + '</th>'; // Row header based on ID
                        var isPulledOver = pulled_over[rowId];
                        var pulledOverClass = isPulledOver ? 'connected' : 'disconnected';
                        tableHtml += '<td><span class="connection-sign ' + pulledOverClass + '"></span></td>'; // Table cell with connection sign
                        tableHtml += '</tr>';
                    }
                    tableHtml += '</tbody></table>';
                } else {
                    tableHtml += 'No data available.'; // Display a message if the JSON data is empty
                }

                // Replace the existing table or message with the updated table structure
                $('#pulled-over-placeholder').html(tableHtml);

                car_1.setLatLng([json[0]['obu1'].latitude, json[0]['obu1'].longitude]).update();
                console.log(json[4]);
                car_2.setLatLng(json[4][0]).update();
                car_3.setLatLng(json[4][1]).update();
                car_4.setLatLng(json[4][2]).update();
                car_5.setLatLng(json[4][3]).update();
                car_6.setLatLng(json[4][4]).update();
            });
        }






        // function kill_sim() {
        //     $.post('/kill_simulation')
        // }

    </script>
</body>

</html>